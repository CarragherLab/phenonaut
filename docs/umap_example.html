<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Example 2 - UMAP &mdash; Phenonaut 1.0.0 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> Phenonaut
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="phenonaut.html">API documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="userguide.html">User guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="publication_examples.html">Publication examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="workflow_guide.html">Workflow mode</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Phenonaut</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Example 2 - UMAP</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/umap_example.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="example-2-umap">
<h1>Example 2 - UMAP<a class="headerlink" href="#example-2-umap" title="Permalink to this headline"></a></h1>
<p>The purpose of example 2 in the lower right portion of Figure 1 in the application note manuscript was to exemplify use of the CMAP packaged dataset, along with user supplied and built-in phenotypic metrics. An interactive Jupyter notebook (Jupyter core version 4.9.1) was used to carry out this analysis with version Python 3.9.5, Phenonaut version 1.0.0, Numpy version 1.20.3, Pandas version 1.4.0, scikit-learn version 0.24.2, and PyTorch version 1.10.2 installed. The notebook can be found in the Phenonaut source repository named “example2_CMAP_metric_groups.ipynb”. The notebook was used to evaluate the built in (Euclidean and Manhattan distances) and user defined phenotypic metrics (TCCS[6] and scalar projection[7]). In this notebook, the CMAP packaged dataset loader is used to obtain a copy of the public CMAP dataset, which is then filtered, keeping only CRISPR perturbation repeats on the A549.311 cell line. The phenotypic metrics are then evaluated using Area Under the Receiver Operator Characterstic Curve (AUROC) metric, indicating their ability to group together repeats. Boxplots of the AUROC performance across repeats are then generated to give an overview of metric performance. The jupyter file “example2_CMAP_metric_groups.ipynb” available in the “Supplemental Data from Object Store” section gives the code listing required to explore and generate the boxplot shown within Figure 1 of the manuscript.
A walkthrough of the notebook follows:</p>
<p>CRISPR (xpr) repeats present in the CMAP dataset offer the possibility to evaluate phenotypic metrics applied to different representations of the level 5 L1000 profiles within the CMAP dataset.  Here, we evaluate metric-feature space pairs and their ability to correctly rank xpr repeats as highly similar to each other.  Metric and feature space pairs are scored through evaluation of the area under receiver operating characteristic (AUROC), with 0.5 representative of random guessing, 1, perfect performance, and 0 representative of perfectly incorrect ranking being applied to xpr repeats.
We now use the CMAP package dataset loader to, extract the A549.311 cell line and perform the evaluation of the following phenotypic metrics:</p>
<ul class="simple">
<li><p>Euclidean distance</p></li>
<li><p>Manhattan/cityblock distance</p></li>
<li><p>Cosine similarity</p></li>
<li><p>Scalar projection</p></li>
</ul>
<p>We evaluate these on:</p>
<ul class="simple">
<li><p>Full feature space</p></li>
<li><p>Standard Scalar feature space</p></li>
<li><p>PCA feature space</p></li>
<li><p>t-SNE feature space</p></li>
<li><p>UMAP feature space.</p></li>
</ul>
<p>t-SNE and UMAP are unsuitable for the application of the cosine similarity and scalar projection, being angular metrics and are not applied.</p>
<p>First, use the Phenonaut CMAP dataloader to load the entire CMAP dataset.  Process it, extracting the A549.311 cell line where treatment is “xpr peturbation” or “ctl_untrt”.
Once processed, save it in a pickle so that it can more quickly be loaded in the future. As a “standard scaler” feature space is required for input to PCA, UMAP and t-SNE, we generate standard scalar dataset.  Next, we define the similarity metrics and scoring function.
In the code below, BASE_PROJECT_DIR took the location of a convenient output directory on the local filesystem.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">phenonaut</span><span class="o">,</span> <span class="nn">phenonaut.transforms</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="n">BASE_PROJECT_DIR</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;projects/cmap&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">BASE_PROJECT_DIR</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
    <span class="n">BASE_PROJECT_DIR</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">phe_object_path</span><span class="o">=</span><span class="n">BASE_PROJECT_DIR</span><span class="o">/</span><span class="s2">&quot;phe_ob_cmap_trt_xpr_A549.311.pickle.gz&quot;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">phe_object_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
    <span class="n">cmap_data</span><span class="o">=</span><span class="n">phenonaut</span><span class="o">.</span><span class="n">packaged_datasets</span><span class="o">.</span><span class="n">CMAP</span><span class="p">(</span><span class="s2">&quot;/local_scratch/data/phenonaut_datasets/cmap&quot;</span><span class="p">)</span>
    <span class="n">phe</span><span class="o">=</span><span class="n">phenonaut</span><span class="o">.</span><span class="n">Phenonaut</span><span class="p">(</span><span class="n">cmap_data</span><span class="p">[</span><span class="s1">&#39;ds&#39;</span><span class="p">])</span>

    <span class="n">phe</span><span class="o">.</span><span class="n">new_dataset_from_query</span><span class="p">(</span><span class="s2">&quot;xpr&quot;</span><span class="p">,</span> <span class="s2">&quot;cell_id==&#39;A549.311&#39; and (pert_type==&#39;trt_xpr&#39; or pert_type==&#39;ctl_untrt&#39;)&quot;</span><span class="p">,</span> <span class="s2">&quot;cmap&quot;</span><span class="p">)</span>
    <span class="n">phe</span><span class="p">[</span><span class="s1">&#39;xpr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">perturbation_column</span><span class="o">=</span><span class="s2">&quot;pert_iname&quot;</span>
    <span class="n">phe</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">phe_object_path</span><span class="p">)</span>
<span class="n">phe</span><span class="o">=</span><span class="n">phenonaut</span><span class="o">.</span><span class="n">Phenonaut</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">phe_object_path</span><span class="p">)</span>
<span class="n">phe</span><span class="o">.</span><span class="n">clone_dataset</span><span class="p">(</span><span class="s2">&quot;xpr&quot;</span><span class="p">,</span> <span class="s2">&quot;xpr_scaled&quot;</span><span class="p">,</span><span class="n">overwrite_existing</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">phenonaut</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">StandardScaler</span><span class="p">()(</span><span class="n">phe</span><span class="p">[</span><span class="s1">&#39;xpr_scaled&#39;</span><span class="p">])</span>
<span class="kn">from</span> <span class="nn">scipy.spatial.distance</span> <span class="kn">import</span> <span class="n">cosine</span> <span class="k">as</span> <span class="n">cosine_distance</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Callable</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">PhenotypicMetric</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">func</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">]</span>
    <span class="n">lower_is_better</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">is_angular</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">PhenotypicMetric</span><span class="p">(</span><span class="s2">&quot;random&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
    <span class="n">PhenotypicMetric</span><span class="p">(</span><span class="s2">&quot;euclidean&quot;</span><span class="p">,</span> <span class="s2">&quot;euclidean&quot;</span><span class="p">),</span>
    <span class="n">PhenotypicMetric</span><span class="p">(</span><span class="s2">&quot;Manhattan&quot;</span><span class="p">,</span> <span class="s2">&quot;cityblock&quot;</span><span class="p">),</span>
    <span class="n">PhenotypicMetric</span><span class="p">(</span><span class="s2">&quot;cosine similarity&quot;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">cosine_distance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">lower_is_better</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">is_angular</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">PhenotypicMetric</span><span class="p">(</span><span class="s2">&quot;scalar projection&quot;</span><span class="p">,</span> <span class="n">phenonaut</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">_scalar_projection_scaled</span><span class="p">,</span> <span class="n">lower_is_better</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">is_angular</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<span class="p">]</span>
<span class="n">metrics_dictionary</span> <span class="o">=</span> <span class="p">{</span><span class="n">m</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">}</span>

<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_auc_score</span>
<span class="k">def</span> <span class="nf">auroc_scores_for_perturbation_repeats</span><span class="p">(</span><span class="n">ds</span><span class="p">:</span><span class="n">phenonaut</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">metric</span><span class="p">:</span><span class="n">PhenotypicMetric</span><span class="p">,</span> <span class="n">average_repeats</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">-&gt;</span><span class="nb">tuple</span><span class="p">:</span>
    <span class="n">pert_scores</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">df_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;perturbation&quot;</span><span class="p">:</span> <span class="p">[]}</span>
    <span class="n">dist_mat</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">distance_df</span><span class="p">(</span>
        <span class="n">ds</span><span class="p">,</span>
        <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="o">.</span><span class="n">func</span><span class="p">,</span>
        <span class="n">lower_is_better</span><span class="o">=</span><span class="n">metric</span><span class="o">.</span><span class="n">lower_is_better</span><span class="p">,</span>
    <span class="p">)</span><span class="o">.</span><span class="n">values</span>
    <span class="k">for</span> <span class="n">pert_name</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">ds</span><span class="o">.</span><span class="n">perturbation_column</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
        <span class="n">pert_indexes</span> <span class="o">=</span> <span class="p">[</span><span class="n">ds</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pert_iname == &#39;</span><span class="si">{</span><span class="n">pert_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        <span class="n">repeat_scores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">lower_is_better</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pert_index</span> <span class="ow">in</span> <span class="n">pert_indexes</span><span class="p">:</span>
                <span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">dist_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
                <span class="n">predictions</span><span class="p">[</span><span class="n">pert_indexes</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">prediction_score</span> <span class="o">=</span> <span class="o">-</span><span class="n">dist_mat</span><span class="p">[</span><span class="n">pert_index</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">rocscore</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">prediction_score</span><span class="p">)</span>
                <span class="n">repeat_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rocscore</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pert_index</span> <span class="ow">in</span> <span class="n">pert_indexes</span><span class="p">:</span>
                <span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">dist_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
                <span class="n">predictions</span><span class="p">[</span><span class="n">pert_indexes</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">prediction_score</span> <span class="o">=</span> <span class="n">dist_mat</span><span class="p">[</span><span class="n">pert_index</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">rocscore</span> <span class="o">=</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">prediction_score</span><span class="p">)</span>
                <span class="n">repeat_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rocscore</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">average_repeats</span><span class="p">:</span>
            <span class="n">df_dict</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">repeat_scores</span><span class="p">))</span>
            <span class="n">df_dict</span><span class="p">[</span><span class="s1">&#39;perturbation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pert_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df_dict</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">repeat_scores</span><span class="p">)</span>
            <span class="n">df_dict</span><span class="p">[</span><span class="s1">&#39;perturbation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">pert_name</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">repeat_scores</span><span class="p">))</span>
        <span class="n">pert_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">repeat_scores</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">pert_scores</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df_dict</span><span class="p">)</span>
</pre></div>
</div>
<p>Next, we generate PCA, UMAP, t-SNE using the standard scalar feature space. ndims = 2 at this stage so we can obtain a unoptimized baseline.</p>
<p>In order to perform a sanity check, the xpr repeats were visualised in PCA, tSNE and UMAP space.</p>
<p>Producing the following figures:</p>
<blockquote>
<div><figure class="align-default" id="id1">
<img alt="PCA scatter of A549.311 cell line" src="_images/example2_pca_scatter.png" />
<figcaption>
<p><span class="caption-text">PCA scatter of CMAP A549.311 cell line CRISPR repeats. Large blue ‘+’ are untreated controls.</span><a class="headerlink" href="#id1" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<figure class="align-default" id="id2">
<img alt="UMAP scatter of A549.311 cell line" src="_images/example2_umap_scatter.png" />
<figcaption>
<p><span class="caption-text">UMAP scatter of CMAP A549.311 cell line CRISPR repeats. Large blue ‘+’ are untreated controls.</span><a class="headerlink" href="#id2" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<figure class="align-default" id="id3">
<img alt="t-SNE scatter of A549.311 cell line" src="_images/example2_tsne_scatter.png" />
<figcaption>
<p><span class="caption-text">t-SNE scatter of CMAP A549.311 cell line CRISPR repeats. Large blue ‘+’ are untreated controls.</span><a class="headerlink" href="#id3" title="Permalink to this image"></a></p>
</figcaption>
</figure>
</div></blockquote>
<p>With local structure present within the UMAP and tSNE scatters for a selection of xpr perturbations which roughly group together, the dataset was deemed appropriate for phenotypic metric performance evaluation.</p>
<p>The following code is used to generate AUROC scores across xpr repeats for appropriate feature space-metric pairs:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="n">BASE_PROJECT_DIR</span><span class="o">/</span><span class="s2">&quot;metric_scores.csv&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
    <span class="k">raise</span> <span class="ne">FileExistsError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">BASE_PROJECT_DIR</span><span class="si">}</span><span class="s2">/metric_scores.csv exists&quot;</span><span class="p">)</span>

<span class="n">perturbation_scores_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="k">for</span> <span class="n">features_name</span><span class="p">,</span> <span class="n">ds_name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
    <span class="p">(</span><span class="s2">&quot;Full&quot;</span><span class="p">,</span> <span class="s2">&quot;Std&quot;</span><span class="p">,</span> <span class="s2">&quot;PCA&quot;</span><span class="p">,</span> <span class="s2">&quot;UMAP&quot;</span><span class="p">,</span> <span class="s2">&quot;t-SNE&quot;</span><span class="p">),</span>
    <span class="p">(</span><span class="s2">&quot;xpr&quot;</span><span class="p">,</span> <span class="s2">&quot;xpr_scaled&quot;</span><span class="p">,</span> <span class="s2">&quot;xpr_scaled_pca&quot;</span><span class="p">,</span> <span class="s2">&quot;xpr_scaled_umap&quot;</span><span class="p">,</span> <span class="s2">&quot;xpr_scaled_tsne&quot;</span><span class="p">),</span>
<span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Working on </span><span class="si">{</span><span class="n">features_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">metric</span><span class="o">.</span><span class="n">is_angular</span> <span class="ow">and</span> <span class="n">features_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;UMAP&#39;</span><span class="p">,</span><span class="s1">&#39;t-SNE&#39;</span><span class="p">]:</span>
            <span class="k">continue</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">metric</span><span class="o">.</span><span class="n">name</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">scores</span><span class="p">,</span> <span class="n">feature_metric_df</span><span class="o">=</span><span class="n">auroc_scores_for_perturbation_repeats</span><span class="p">(</span><span class="n">phe</span><span class="p">[</span><span class="n">ds_name</span><span class="p">],</span><span class="n">metric</span><span class="p">)</span>
        <span class="n">feature_metric_df</span><span class="p">[</span><span class="s2">&quot;metric_name&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">metric</span><span class="o">.</span><span class="n">name</span>
        <span class="n">feature_metric_df</span><span class="p">[</span><span class="s2">&quot;features&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">features_name</span>
        <span class="n">perturbation_scores_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">perturbation_scores_df</span><span class="p">,</span> <span class="n">feature_metric_df</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">perturbation_scores_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">BASE_PROJECT_DIR</span><span class="o">/</span><span class="s2">&quot;metric_scores.csv&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>A boxplot was then generated to summarise the results of the above metric evaluation:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="n">metric_scores_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">BASE_PROJECT_DIR</span><span class="o">/</span><span class="s2">&quot;metric_scores.csv&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
<span class="c1"># the size of A4 paper</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mf">12.0</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">metric_scores_df</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;score&quot;</span><span class="p">,</span>
    <span class="n">x</span><span class="o">=</span><span class="s2">&quot;metric_name&quot;</span><span class="p">,</span>
    <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;features&quot;</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
    <span class="n">showmeans</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">meanprops</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;marker&quot;</span><span class="p">:</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;markerfacecolor&quot;</span><span class="p">:</span> <span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="s2">&quot;markeredgecolor&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="s2">&quot;markersize&quot;</span><span class="p">:</span> <span class="s2">&quot;10&quot;</span><span class="p">},</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Metric&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;AUROC&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;AUROC scores of average xpr repeat reproducibility across phenotypic metrics and feature spaces&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">BASE_PROJECT_DIR</span><span class="o">/</span><span class="s2">&quot;boxplot.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</pre></div>
</div>
<p>Resulting in the following figure:</p>
<figure class="align-default" id="id4">
<img alt="Boxplot of phenotypic metric performance" src="_images/example2_boxplot_noopt.png" />
<figcaption>
<p><span class="caption-text">Boxplot of AUROC scores across averaged xpr repeats of the A549.311 cell line within CMAP. For each dimensionality reduction technique (PCA, UMAP and tSNE), 2 dimensions were requested, and all other options kept to default settings.</span><a class="headerlink" href="#id4" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>The above figure gives us an insight into metric-feature space performance, but statistically testing all distributions against the others will allow us to recommend a metric-feature space pair.  For this, we use the Mann-Whitney U rank test in a 1-tailed mode, testing the alternative hypothesis that a distribution is stochastically greater than the other. This produces a matrix as shown in Figure S7, and summarised in Figure S8.  Once calculated, two representative heatmaps can be generated.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="n">metric_scores_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">BASE_PROJECT_DIR</span><span class="o">/</span><span class="s2">&quot;metric_scores.csv&quot;</span><span class="p">)</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">FeatureSpaceAndMetric</span><span class="p">():</span>
    <span class="n">featurespace</span><span class="p">:</span><span class="nb">str</span>
    <span class="n">metric</span><span class="p">:</span><span class="n">PhenotypicMetric</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">mannwhitneyu</span>
<span class="n">featurespeace_metric_combinations</span><span class="o">=</span><span class="p">[</span><span class="n">FeatureSpaceAndMetric</span><span class="p">(</span><span class="n">feature_space</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span> <span class="k">for</span> <span class="n">feature_space</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Full&quot;</span><span class="p">,</span> <span class="s2">&quot;Std&quot;</span><span class="p">,</span> <span class="s2">&quot;PCA&quot;</span><span class="p">,</span> <span class="s2">&quot;UMAP&quot;</span><span class="p">,</span> <span class="s2">&quot;t-SNE&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">metrics</span> <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span><span class="s2">&quot;random&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">metric</span><span class="o">.</span><span class="n">is_angular</span> <span class="ow">and</span> <span class="n">feature_space</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;UMAP&#39;</span><span class="p">,</span> <span class="s1">&#39;t-SNE&#39;</span><span class="p">])]</span>

<span class="n">pvals</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">featurespeace_metric_combinations</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">featurespeace_metric_combinations</span><span class="p">)),</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i1</span><span class="p">,</span> <span class="n">fsm1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">featurespeace_metric_combinations</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i2</span><span class="p">,</span> <span class="n">fsm2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">featurespeace_metric_combinations</span><span class="p">):</span>
        <span class="n">vals1</span><span class="o">=</span><span class="n">metric_scores_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;features==&#39;</span><span class="si">{</span><span class="n">fsm1</span><span class="o">.</span><span class="n">featurespace</span><span class="si">}</span><span class="s2">&#39; and metric_name==&#39;</span><span class="si">{</span><span class="n">fsm1</span><span class="o">.</span><span class="n">metric</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">vals2</span><span class="o">=</span><span class="n">metric_scores_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;features==&#39;</span><span class="si">{</span><span class="n">fsm2</span><span class="o">.</span><span class="n">featurespace</span><span class="si">}</span><span class="s2">&#39; and metric_name==&#39;</span><span class="si">{</span><span class="n">fsm2</span><span class="o">.</span><span class="n">metric</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">pvals</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">]</span><span class="o">=</span><span class="n">mannwhitneyu</span><span class="p">(</span><span class="n">vals1</span><span class="p">,</span> <span class="n">vals2</span><span class="p">,</span><span class="n">alternative</span><span class="o">=</span><span class="s2">&quot;greater&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pvalue</span>
<span class="n">mwu_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">pvals</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fsm</span><span class="o">.</span><span class="n">featurespace</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">fsm</span><span class="o">.</span><span class="n">metric</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">fsm</span> <span class="ow">in</span> <span class="n">featurespeace_metric_combinations</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fsm</span><span class="o">.</span><span class="n">featurespace</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">fsm</span><span class="o">.</span><span class="n">metric</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">fsm</span> <span class="ow">in</span> <span class="n">featurespeace_metric_combinations</span><span class="p">])</span>
<span class="kn">from</span> <span class="nn">phenonaut.output</span> <span class="kn">import</span> <span class="n">write_heatmap_from_df</span>
<span class="n">write_heatmap_from_df</span><span class="p">(</span><span class="n">mwu_df</span><span class="p">,</span><span class="s2">&quot;1-tailed (greater) Mann-Whitney U tests. P values for query metric-features pair AUROC scores being the same or less than candidate metric-features pair AUROC scores&quot;</span><span class="p">,</span> <span class="n">BASE_PROJECT_DIR</span><span class="o">/</span><span class="s2">&quot;mwu-heatmap.png&quot;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">16</span><span class="p">),</span> <span class="n">lower_is_better</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">highlight_best</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">put_cbar_on_left</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis_labels</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Candidate metric-features pair A&quot;</span><span class="p">,</span> <span class="s2">&quot;Query metric-features pair&quot;</span><span class="p">))</span>
<span class="n">better_than_count</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pvals</span><span class="p">[:]</span><span class="o">&lt;</span><span class="mf">0.05</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">better_than_count</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">better_than_count</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">better_than_count</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">better_than_count</span><span class="p">,</span><span class="n">better_than_count</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<span class="n">better_than_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">better_than_count</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Full&quot;</span><span class="p">,</span> <span class="s2">&quot;Std&quot;</span><span class="p">,</span> <span class="s2">&quot;PCA&quot;</span><span class="p">,</span> <span class="s2">&quot;UMAP&quot;</span><span class="p">,</span> <span class="s2">&quot;t-SNE&quot;</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">metrics</span> <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span><span class="s2">&quot;random&quot;</span><span class="p">])</span>
<span class="n">custom_annotation</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">better_than_df</span><span class="p">)</span>
<span class="n">custom_annotation</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="s1">&#39;UMAP&#39;</span><span class="p">,</span><span class="s1">&#39;t-SNE&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;scalar projection&#39;</span><span class="p">,</span> <span class="s1">&#39;cosine similarity&#39;</span><span class="p">]]</span><span class="o">=</span><span class="s2">&quot;NA&quot;</span>
<span class="n">write_heatmap_from_df</span><span class="p">(</span><span class="n">better_than_df</span><span class="p">,</span><span class="s2">&quot;Num significant at 0.05 level&quot;</span><span class="p">,</span> <span class="n">BASE_PROJECT_DIR</span><span class="o">/</span><span class="s2">&quot;mwu-betterthan-heatmap.png&quot;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">lower_is_better</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">annotation_format_string_value</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="n">custom_annotation</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">sns_colour_palette</span><span class="o">=</span><span class="s2">&quot;Blues&quot;</span><span class="p">)</span>
</pre></div>
</div>
<figure class="align-default" id="id5">
<img alt="Heatmap of Mann-Whitney U metric performance (one tailed, greater than)" src="_images/example2_heatmap_noopt.png" />
<figcaption>
<p><span class="caption-text">1-tailed Mann Whitney-U (greater than) test, evaluating if the query metric-feature space combination is better than the candidate-feature space combination. Values denote p-values that the metric-feature space combination in a given row is performed better than the metric-feature space column given in the column by chance along.  If this value is &lt;0.05, we deem there to be a less than 5 % chance that the metric-feature space combination outperformed the other by chance.</span><a class="headerlink" href="#id5" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<figure class="align-default" id="id6">
<img alt="Heatmap summary of Mann-Whitney U metric performance (one tailed, greater than)" src="_images/example2_heatmap_summary_noopt.png" />
<figcaption>
<p><span class="caption-text">Counts of the number of features-space metric pairs that were significantly better performing than other metric-feature space pairs. Suggests that scalar projection applied to full and standard scalar feature space outperforms the same number of metric-feature space pairs as cosine similarity applied to standard scalar feature space.</span><a class="headerlink" href="#id6" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>Whilst the above shows that scalar projection applied to full and standard scalar feature space outperforms the same number of metric-feature space pairs as cosine similarity applied to standard scalar feature space, there is no significant (at the 0.05 level) performance difference between any of those top metric-feature space combinations, as evidenced in Figure S7.
Additionally, the PCA, UMAP and t-SNE feature spaces are in 2 dimensions only. This can be optimised using a simple scanning approach to reach optimum AUROC scores for each metric-feature space pair.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">phenonaut.transforms.dimensionality_reduction</span> <span class="kn">import</span> <span class="n">PCA</span><span class="p">,</span><span class="n">TSNE</span><span class="p">,</span><span class="n">UMAP</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Callable</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span><span class="p">,</span> <span class="n">auto</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="n">ndims_scan_csv_file</span><span class="o">=</span><span class="n">BASE_PROJECT_DIR</span><span class="o">/</span><span class="s2">&quot;res_ndims_scan.csv&quot;</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">ndims_scan_csv_file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>

    <span class="k">def</span> <span class="nf">eval_all_metrics</span><span class="p">(</span><span class="n">sds</span><span class="p">,</span> <span class="n">num_dimensions</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">num_dimensions</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">center_on_perturbation</span> <span class="o">=</span> <span class="s2">&quot;UnTrt&quot;</span>
        <span class="n">pca_ds</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">sds</span><span class="p">)</span>
        <span class="n">PCA</span><span class="p">()(</span><span class="n">pca_ds</span><span class="p">,</span> <span class="n">ndims</span><span class="o">=</span><span class="n">num_dimensions</span><span class="p">,</span> <span class="n">center_on_perturbation_id</span><span class="o">=</span><span class="n">center_on_perturbation</span><span class="p">)</span>
        <span class="n">tsne_ds</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">sds</span><span class="p">)</span>
        <span class="n">TSNE</span><span class="p">()(</span><span class="n">tsne_ds</span><span class="p">,</span> <span class="n">ndims</span><span class="o">=</span><span class="n">num_dimensions</span><span class="p">,</span> <span class="n">center_on_perturbation_id</span><span class="o">=</span><span class="n">center_on_perturbation</span><span class="p">)</span>
        <span class="n">umap_ds</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">sds</span><span class="p">)</span>
        <span class="n">UMAP</span><span class="p">()(</span><span class="n">umap_ds</span><span class="p">,</span> <span class="n">ndims</span><span class="o">=</span><span class="n">num_dimensions</span><span class="p">,</span> <span class="n">center_on_perturbation_id</span><span class="o">=</span><span class="n">center_on_perturbation</span><span class="p">)</span>
        <span class="n">results</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">([</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">metrics</span> <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;random&quot;</span><span class="p">]),</span> <span class="mi">3</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">metrics</span> <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;random&quot;</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">angular_is_ok</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(((</span><span class="n">pca_ds</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span> <span class="p">(</span><span class="n">tsne_ds</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="p">(</span><span class="n">umap_ds</span><span class="p">,</span> <span class="kc">False</span><span class="p">))):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">metric</span><span class="o">.</span><span class="n">is_angular</span> <span class="ow">or</span> <span class="p">(</span><span class="n">metric</span><span class="o">.</span><span class="n">is_angular</span> <span class="ow">and</span> <span class="n">angular_is_ok</span><span class="p">):</span>
                    <span class="n">auroc_scores</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">auroc_scores_for_perturbation_repeats</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">metric</span><span class="p">)</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">auroc_scores</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">return</span> <span class="n">results</span>

    <span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
    <span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>


    <span class="n">sds</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">phe</span><span class="p">[</span><span class="s2">&quot;xpr_scaled&quot;</span><span class="p">])</span>

    <span class="n">n_dims_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">sds</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">sds</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">n_dims_list</span><span class="p">)</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># [PCA, tSNE, UMAP], metric, dimensions</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">()</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="n">eval_all_metrics</span><span class="p">,</span> <span class="p">((</span><span class="n">sds</span><span class="p">,</span> <span class="n">nd</span><span class="p">)</span> <span class="k">for</span> <span class="n">nd</span> <span class="ow">in</span> <span class="n">n_dims_list</span><span class="p">)))</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> <span class="c1"># ATTENTION HERE</span>

    <span class="n">df_metric_list</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">df_features_list</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">df_ndims_list</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">df_score_list</span><span class="o">=</span><span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
                <span class="n">df_ndims_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">df_metric_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">metrics</span> <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;random&quot;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">df_features_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;PCA&quot;</span><span class="p">,</span> <span class="s2">&quot;tSNE&quot;</span><span class="p">,</span> <span class="s2">&quot;UMAP&quot;</span><span class="p">][</span><span class="n">k</span><span class="p">])</span>
                <span class="n">df_score_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">])</span>

    <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;metric&quot;</span><span class="p">:</span><span class="n">df_metric_list</span><span class="p">,</span> <span class="s2">&quot;features&quot;</span><span class="p">:</span><span class="n">df_features_list</span><span class="p">,</span> <span class="s2">&quot;ndims&quot;</span><span class="p">:</span><span class="n">df_ndims_list</span><span class="p">,</span> <span class="s2">&quot;score&quot;</span><span class="p">:</span><span class="n">df_score_list</span><span class="p">})</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">ndims_scan_csv_file</span><span class="p">)</span>
<span class="c1"># CSV file exists or has been generated above</span>
<span class="n">ndims_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">ndims_scan_csv_file</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">7</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">ndims_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;features==&quot;PCA&quot;&#39;</span><span class="p">),</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;ndims&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;score&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s1">&#39;PCA - ndims vs AUROC score&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">ndims_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;features==&quot;UMAP&quot; and metric!=&quot;cosine similarity&quot; and metric!=&quot;scalar projection&quot;&#39;</span><span class="p">),</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;ndims&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;score&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s1">&#39;UMAP - ndims vs AUROC score&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">ndims_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;features==&quot;tSNE&quot; and metric!=&quot;cosine similarity&quot; and metric!=&quot;scalar projection&quot;&#39;</span><span class="p">),</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;ndims&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;score&quot;</span><span class="p">,</span> <span class="n">style</span><span class="o">=</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">set_text</span><span class="p">(</span><span class="s1">&#39;t-SNE - ndims vs AUROC score&#39;</span><span class="p">)</span>
<span class="n">lines_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">fig</span><span class="o">.</span><span class="n">axes</span><span class="p">]</span>
<span class="n">lines</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="nb">sum</span><span class="p">(</span><span class="n">lol</span><span class="p">,</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">lol</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">lines_labels</span><span class="p">)]</span>
<span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">ax</span><span class="p">:</span> <span class="n">sns</span><span class="o">.</span><span class="n">move_legend</span><span class="p">(</span><span class="n">axis</span><span class="p">,</span> <span class="s2">&quot;lower right&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">BASE_PROJECT_DIR</span><span class="o">/</span><span class="s2">&quot;ndims_optimisation_scatter.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</pre></div>
</div>
<p>Producing the following:</p>
<figure class="align-default" id="id7">
<img alt="ndims optimisation scatter for dimensionality reduction techniques" src="_images/example2_ndims_scatter.png" />
<figcaption>
<p><span class="caption-text">AUROC scores for PCA, UMAP and t-SNE feature spaces across a range of dimensions for each appropriate metric.</span><a class="headerlink" href="#id7" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>The top performing ndims for each metric-feature space are summarised in the table below.</p>
<p>Optimal number of dimensions (maximising AUROC scores) for each metric-feature space pair (AUROC).</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 23%" />
<col style="width: 24%" />
<col style="width: 26%" />
<col style="width: 27%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Metric</p></th>
<th class="head"><p>PCA optimized ndims</p></th>
<th class="head"><p>UMAP optimized ndims</p></th>
<th class="head"><p>t-SNE optimized ndims</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Euclidean</p></td>
<td><p>36</p></td>
<td><p>227</p></td>
<td><p>2</p></td>
</tr>
<tr class="row-odd"><td><p>Manhattan</p></td>
<td><p>24</p></td>
<td><p>288</p></td>
<td><p>2</p></td>
</tr>
<tr class="row-even"><td><p>Cosine similarity</p></td>
<td><p>78</p></td>
<td><p>NA</p></td>
<td><p>NA</p></td>
</tr>
<tr class="row-odd"><td><p>Scalar projection</p></td>
<td><p>356</p></td>
<td><p>NA</p></td>
<td><p>NA</p></td>
</tr>
</tbody>
</table>
<p>With the optimum number of dimensions for metric-feature space pairs determined, we may calculate AUROC scores again.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">metric_scores</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;metric_name&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;score&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="p">[]}</span>
<span class="n">metrics_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">m</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">}</span>
<span class="n">perturbation_scores_ndim_opt</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">metrics_dict</span><span class="p">)</span>
<span class="n">ds_pca_36</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">phe</span><span class="p">[</span><span class="s2">&quot;xpr_scaled&quot;</span><span class="p">])</span>
<span class="n">PCA</span><span class="p">()(</span><span class="n">ds_pca_36</span><span class="p">,</span> <span class="n">ndims</span><span class="o">=</span><span class="mi">36</span><span class="p">,</span> <span class="n">center_on_perturbation_id</span><span class="o">=</span><span class="n">center_on_perturbation</span><span class="p">)</span>
<span class="n">ds_pca_24</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">phe</span><span class="p">[</span><span class="s2">&quot;xpr_scaled&quot;</span><span class="p">])</span>
<span class="n">PCA</span><span class="p">()(</span><span class="n">ds_pca_24</span><span class="p">,</span> <span class="n">ndims</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">center_on_perturbation_id</span><span class="o">=</span><span class="n">center_on_perturbation</span><span class="p">)</span>
<span class="n">ds_pca_78</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">phe</span><span class="p">[</span><span class="s2">&quot;xpr_scaled&quot;</span><span class="p">])</span>
<span class="n">PCA</span><span class="p">()(</span><span class="n">ds_pca_78</span><span class="p">,</span> <span class="n">ndims</span><span class="o">=</span><span class="mi">78</span><span class="p">,</span> <span class="n">center_on_perturbation_id</span><span class="o">=</span><span class="n">center_on_perturbation</span><span class="p">)</span>
<span class="n">ds_pca_356</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">phe</span><span class="p">[</span><span class="s2">&quot;xpr_scaled&quot;</span><span class="p">])</span>
<span class="n">PCA</span><span class="p">()(</span><span class="n">ds_pca_356</span><span class="p">,</span> <span class="n">ndims</span><span class="o">=</span><span class="mi">356</span><span class="p">,</span> <span class="n">center_on_perturbation_id</span><span class="o">=</span><span class="n">center_on_perturbation</span><span class="p">)</span>

<span class="n">ds_tsne_2</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">phe</span><span class="p">[</span><span class="s2">&quot;xpr_scaled&quot;</span><span class="p">])</span>
<span class="n">TSNE</span><span class="p">()(</span><span class="n">ds_tsne_2</span><span class="p">,</span> <span class="n">ndims</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="n">ds_umap_227</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">phe</span><span class="p">[</span><span class="s2">&quot;xpr_scaled&quot;</span><span class="p">])</span>
<span class="n">UMAP</span><span class="p">()(</span><span class="n">ds_umap_227</span><span class="p">,</span> <span class="n">ndims</span><span class="o">=</span><span class="mi">227</span><span class="p">)</span>
<span class="n">ds_umap_288</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">phe</span><span class="p">[</span><span class="s2">&quot;xpr_scaled&quot;</span><span class="p">])</span>
<span class="n">UMAP</span><span class="p">()(</span><span class="n">ds_umap_288</span><span class="p">,</span> <span class="n">ndims</span><span class="o">=</span><span class="mi">288</span><span class="p">)</span>

<span class="k">for</span> <span class="n">features_name</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="p">[</span>
    <span class="p">(</span><span class="s2">&quot;Full&quot;</span><span class="p">,</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">phe</span><span class="p">[</span><span class="s2">&quot;xpr&quot;</span><span class="p">]),</span> <span class="n">metrics_dict</span><span class="p">[</span><span class="s2">&quot;random&quot;</span><span class="p">]),</span>
    <span class="p">(</span><span class="s2">&quot;Std&quot;</span><span class="p">,</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">phe</span><span class="p">[</span><span class="s2">&quot;xpr_scaled&quot;</span><span class="p">]),</span> <span class="n">metrics_dict</span><span class="p">[</span><span class="s2">&quot;random&quot;</span><span class="p">]),</span>
    <span class="p">(</span><span class="s2">&quot;PCA&quot;</span><span class="p">,</span> <span class="n">ds_pca_24</span><span class="p">,</span> <span class="n">metrics_dict</span><span class="p">[</span><span class="s2">&quot;random&quot;</span><span class="p">]),</span>
    <span class="p">(</span><span class="s2">&quot;UMAP&quot;</span><span class="p">,</span> <span class="n">ds_umap_227</span><span class="p">,</span> <span class="n">metrics_dict</span><span class="p">[</span><span class="s2">&quot;random&quot;</span><span class="p">]),</span>
    <span class="p">(</span><span class="s2">&quot;t-SNE&quot;</span><span class="p">,</span> <span class="n">ds_tsne_2</span><span class="p">,</span> <span class="n">metrics_dict</span><span class="p">[</span><span class="s2">&quot;random&quot;</span><span class="p">]),</span>
    <span class="p">(</span><span class="s2">&quot;Full&quot;</span><span class="p">,</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">phe</span><span class="p">[</span><span class="s2">&quot;xpr&quot;</span><span class="p">]),</span> <span class="n">metrics_dict</span><span class="p">[</span><span class="s2">&quot;euclidean&quot;</span><span class="p">]),</span>
    <span class="p">(</span><span class="s2">&quot;Std&quot;</span><span class="p">,</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">phe</span><span class="p">[</span><span class="s2">&quot;xpr_scaled&quot;</span><span class="p">]),</span> <span class="n">metrics_dict</span><span class="p">[</span><span class="s2">&quot;euclidean&quot;</span><span class="p">]),</span>
    <span class="p">(</span><span class="s2">&quot;PCA&quot;</span><span class="p">,</span> <span class="n">ds_pca_36</span><span class="p">,</span> <span class="n">metrics_dict</span><span class="p">[</span><span class="s2">&quot;euclidean&quot;</span><span class="p">]),</span>
    <span class="p">(</span><span class="s2">&quot;UMAP&quot;</span><span class="p">,</span> <span class="n">ds_umap_227</span><span class="p">,</span> <span class="n">metrics_dict</span><span class="p">[</span><span class="s2">&quot;euclidean&quot;</span><span class="p">]),</span>
    <span class="p">(</span><span class="s2">&quot;t-SNE&quot;</span><span class="p">,</span> <span class="n">ds_tsne_2</span><span class="p">,</span> <span class="n">metrics_dict</span><span class="p">[</span><span class="s2">&quot;euclidean&quot;</span><span class="p">]),</span>
    <span class="p">(</span><span class="s2">&quot;Full&quot;</span><span class="p">,</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">phe</span><span class="p">[</span><span class="s2">&quot;xpr&quot;</span><span class="p">]),</span> <span class="n">metrics_dict</span><span class="p">[</span><span class="s2">&quot;Manhattan&quot;</span><span class="p">]),</span>
    <span class="p">(</span><span class="s2">&quot;Std&quot;</span><span class="p">,</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">phe</span><span class="p">[</span><span class="s2">&quot;xpr_scaled&quot;</span><span class="p">]),</span> <span class="n">metrics_dict</span><span class="p">[</span><span class="s2">&quot;Manhattan&quot;</span><span class="p">]),</span>
    <span class="p">(</span><span class="s2">&quot;PCA&quot;</span><span class="p">,</span> <span class="n">ds_pca_24</span><span class="p">,</span> <span class="n">metrics_dict</span><span class="p">[</span><span class="s2">&quot;Manhattan&quot;</span><span class="p">]),</span>
    <span class="p">(</span><span class="s2">&quot;UMAP&quot;</span><span class="p">,</span> <span class="n">ds_umap_288</span><span class="p">,</span> <span class="n">metrics_dict</span><span class="p">[</span><span class="s2">&quot;Manhattan&quot;</span><span class="p">]),</span>
    <span class="p">(</span><span class="s2">&quot;t-SNE&quot;</span><span class="p">,</span> <span class="n">ds_tsne_2</span><span class="p">,</span> <span class="n">metrics_dict</span><span class="p">[</span><span class="s2">&quot;Manhattan&quot;</span><span class="p">]),</span>
    <span class="p">(</span><span class="s2">&quot;Full&quot;</span><span class="p">,</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">phe</span><span class="p">[</span><span class="s2">&quot;xpr&quot;</span><span class="p">]),</span> <span class="n">metrics_dict</span><span class="p">[</span><span class="s2">&quot;cosine similarity&quot;</span><span class="p">]),</span>
    <span class="p">(</span><span class="s2">&quot;Std&quot;</span><span class="p">,</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">phe</span><span class="p">[</span><span class="s2">&quot;xpr_scaled&quot;</span><span class="p">]),</span> <span class="n">metrics_dict</span><span class="p">[</span><span class="s2">&quot;cosine similarity&quot;</span><span class="p">]),</span>
    <span class="p">(</span><span class="s2">&quot;PCA&quot;</span><span class="p">,</span> <span class="n">ds_pca_78</span><span class="p">,</span> <span class="n">metrics_dict</span><span class="p">[</span><span class="s2">&quot;cosine similarity&quot;</span><span class="p">]),</span>
    <span class="p">(</span><span class="s2">&quot;Full&quot;</span><span class="p">,</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">phe</span><span class="p">[</span><span class="s2">&quot;xpr&quot;</span><span class="p">]),</span> <span class="n">metrics_dict</span><span class="p">[</span><span class="s2">&quot;scalar projection&quot;</span><span class="p">]),</span>
    <span class="p">(</span><span class="s2">&quot;Std&quot;</span><span class="p">,</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">phe</span><span class="p">[</span><span class="s2">&quot;xpr_scaled&quot;</span><span class="p">]),</span> <span class="n">metrics_dict</span><span class="p">[</span><span class="s2">&quot;scalar projection&quot;</span><span class="p">]),</span>
    <span class="p">(</span><span class="s2">&quot;PCA&quot;</span><span class="p">,</span> <span class="n">ds_pca_356</span><span class="p">,</span> <span class="n">metrics_dict</span><span class="p">[</span><span class="s2">&quot;scalar projection&quot;</span><span class="p">]),</span>
<span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Working on </span><span class="si">{</span><span class="n">features_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">scores</span><span class="p">,</span> <span class="n">feature_metric_df</span><span class="o">=</span><span class="n">auroc_scores_for_perturbation_repeats</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span><span class="n">metric</span><span class="p">)</span>
    <span class="n">feature_metric_df</span><span class="p">[</span><span class="s2">&quot;metric_name&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">metric</span><span class="o">.</span><span class="n">name</span>
    <span class="n">feature_metric_df</span><span class="p">[</span><span class="s2">&quot;features&quot;</span><span class="p">]</span><span class="o">=</span><span class="n">features_name</span>
    <span class="n">perturbation_scores_ndim_opt</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">perturbation_scores_ndim_opt</span><span class="p">,</span> <span class="n">feature_metric_df</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">perturbation_scores_ndim_opt</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">BASE_PROJECT_DIR</span> <span class="o">/</span> <span class="s2">&quot;optimised_perturbation_scores_ndim_opt.csv&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>and visualise:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">BASE_PROJECT_DIR</span> <span class="o">/</span> <span class="s2">&quot;optimised_perturbation_scores_ndim_opt.csv&quot;</span><span class="p">)</span>

<span class="c1"># data[&#39;score&#39;]=data[&#39;score&#39;].clip(upper=12000)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
<span class="c1"># the size of A4 paper</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mf">12.0</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
    <span class="n">y</span><span class="o">=</span><span class="s2">&quot;score&quot;</span><span class="p">,</span>
    <span class="n">x</span><span class="o">=</span><span class="s2">&quot;metric_name&quot;</span><span class="p">,</span>
    <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;features&quot;</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
    <span class="n">showmeans</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">meanprops</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;marker&quot;</span><span class="p">:</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;markerfacecolor&quot;</span><span class="p">:</span> <span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="s2">&quot;markeredgecolor&quot;</span><span class="p">:</span> <span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="s2">&quot;markersize&quot;</span><span class="p">:</span> <span class="s2">&quot;10&quot;</span><span class="p">},</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">BASE_PROJECT_DIR</span><span class="o">/</span><span class="s2">&quot;scores.csv&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Metric&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;AUROC&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">BASE_PROJECT_DIR</span><span class="o">/</span><span class="s2">&quot;boxplot_opt.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</pre></div>
</div>
<figure class="align-default" id="id8">
<img alt="ndims optimised metric performance boxplots." src="_images/example2_boxplot_opt.png" />
<figcaption>
<p><span class="caption-text">Boxplot of AUROC scores across averaged xpr repeats of the A549.311 cell line within CMAP. For each dimensionality reduction technique (PCA, UMAP and tSNE), the optimum number of dimensions were used to maximise AUROC scores, indicating the throretical maximum scores achievable using these metric-feature space pairs, other options kept to default settings.</span><a class="headerlink" href="#id8" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<p>Similarly to before, we may repeat the statistical testing to evaluate metric-feature space pair performance with each other.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">mannwhitneyu</span>

<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="n">optimised_perturbation_scores_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">BASE_PROJECT_DIR</span><span class="o">/</span><span class="s2">&quot;optimised_perturbation_scores.csv&quot;</span><span class="p">)</span>
<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">FeatureSpaceAndMetric</span><span class="p">():</span>
    <span class="n">featurespace</span><span class="p">:</span><span class="nb">str</span>
    <span class="n">metric</span><span class="p">:</span><span class="n">PhenotypicMetric</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">mannwhitneyu</span>
<span class="n">featurespeace_metric_combinations</span><span class="o">=</span><span class="p">[</span><span class="n">FeatureSpaceAndMetric</span><span class="p">(</span><span class="n">feature_space</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span> <span class="k">for</span> <span class="n">feature_space</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Full&quot;</span><span class="p">,</span> <span class="s2">&quot;Std&quot;</span><span class="p">,</span> <span class="s2">&quot;PCA&quot;</span><span class="p">,</span> <span class="s2">&quot;UMAP&quot;</span><span class="p">,</span> <span class="s2">&quot;t-SNE&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">metrics</span> <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span><span class="s2">&quot;random&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">metric</span><span class="o">.</span><span class="n">is_angular</span> <span class="ow">and</span> <span class="n">feature_space</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;UMAP&#39;</span><span class="p">,</span> <span class="s1">&#39;t-SNE&#39;</span><span class="p">])]</span>

<span class="n">pvals</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">featurespeace_metric_combinations</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">featurespeace_metric_combinations</span><span class="p">)),</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i1</span><span class="p">,</span> <span class="n">fsm1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">featurespeace_metric_combinations</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i2</span><span class="p">,</span> <span class="n">fsm2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">featurespeace_metric_combinations</span><span class="p">):</span>
        <span class="n">vals1</span><span class="o">=</span><span class="n">optimised_perturbation_scores_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;features==&#39;</span><span class="si">{</span><span class="n">fsm1</span><span class="o">.</span><span class="n">featurespace</span><span class="si">}</span><span class="s2">&#39; and metric_name==&#39;</span><span class="si">{</span><span class="n">fsm1</span><span class="o">.</span><span class="n">metric</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">vals2</span><span class="o">=</span><span class="n">optimised_perturbation_scores_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;features==&#39;</span><span class="si">{</span><span class="n">fsm2</span><span class="o">.</span><span class="n">featurespace</span><span class="si">}</span><span class="s2">&#39; and metric_name==&#39;</span><span class="si">{</span><span class="n">fsm2</span><span class="o">.</span><span class="n">metric</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">pvals</span><span class="p">[</span><span class="n">i1</span><span class="p">,</span> <span class="n">i2</span><span class="p">]</span><span class="o">=</span><span class="n">mannwhitneyu</span><span class="p">(</span><span class="n">vals1</span><span class="p">,</span> <span class="n">vals2</span><span class="p">,</span><span class="n">alternative</span><span class="o">=</span><span class="s2">&quot;greater&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pvalue</span>
<span class="n">mwu_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">pvals</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fsm</span><span class="o">.</span><span class="n">featurespace</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">fsm</span><span class="o">.</span><span class="n">metric</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">fsm</span> <span class="ow">in</span> <span class="n">featurespeace_metric_combinations</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">fsm</span><span class="o">.</span><span class="n">featurespace</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">fsm</span><span class="o">.</span><span class="n">metric</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">fsm</span> <span class="ow">in</span> <span class="n">featurespeace_metric_combinations</span><span class="p">])</span>
<span class="kn">from</span> <span class="nn">phenonaut.output</span> <span class="kn">import</span> <span class="n">write_heatmap_from_df</span>
<span class="c1">#write_heatmap_from_df(mwu_df,&quot;1-tailed (greater) Mann-Whitney U&quot;, BASE_PROJECT_DIR/&quot;mwu_heatmap_opt.png&quot;, figsize=(20,16), lower_is_better=True, highlight_best=False)</span>
<span class="n">write_heatmap_from_df</span><span class="p">(</span><span class="n">mwu_df</span><span class="p">,</span><span class="s2">&quot;1-tailed (greater) Mann-Whitney U tests. P values for query metric-features pair AUROC scores being the same or less than candidate metric-features pair AUROC scores&quot;</span><span class="p">,</span> <span class="n">BASE_PROJECT_DIR</span><span class="o">/</span><span class="s2">&quot;mwu-heatmap.png&quot;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">16</span><span class="p">),</span> <span class="n">lower_is_better</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">highlight_best</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">put_cbar_on_left</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis_labels</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Candidate metric-features pair&quot;</span><span class="p">,</span> <span class="s2">&quot;Query metric-features pair&quot;</span><span class="p">),</span> <span class="n">sns_colour_palette</span><span class="o">=</span><span class="s2">&quot;Blues&quot;</span><span class="p">)</span>

<span class="n">better_than_count</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pvals</span><span class="p">[:]</span><span class="o">&lt;</span><span class="mf">0.05</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">better_than_count</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">better_than_count</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">better_than_count</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">better_than_count</span><span class="p">,</span><span class="n">better_than_count</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<span class="n">better_than_df</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">better_than_count</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Full&quot;</span><span class="p">,</span> <span class="s2">&quot;Std&quot;</span><span class="p">,</span> <span class="s2">&quot;PCA&quot;</span><span class="p">,</span> <span class="s2">&quot;UMAP&quot;</span><span class="p">,</span> <span class="s2">&quot;t-SNE&quot;</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">metrics</span> <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span><span class="s2">&quot;random&quot;</span><span class="p">])</span>
<span class="n">custom_annotation</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">better_than_df</span><span class="p">)</span>
<span class="n">custom_annotation</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="s1">&#39;UMAP&#39;</span><span class="p">,</span><span class="s1">&#39;t-SNE&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;scalar projection&#39;</span><span class="p">,</span> <span class="s1">&#39;cosine similarity&#39;</span><span class="p">]]</span><span class="o">=</span><span class="s2">&quot;NA&quot;</span>
<span class="n">write_heatmap_from_df</span><span class="p">(</span><span class="n">better_than_df</span><span class="p">,</span><span class="s2">&quot;Num significant at 0.05 level&quot;</span><span class="p">,</span> <span class="n">BASE_PROJECT_DIR</span><span class="o">/</span><span class="s2">&quot;betterthan_heatmap_opt.png&quot;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">lower_is_better</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">annotation_format_string_value</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="n">annot</span><span class="o">=</span><span class="n">custom_annotation</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">sns_colour_palette</span><span class="o">=</span><span class="s2">&quot;Blues&quot;</span><span class="p">)</span>
</pre></div>
</div>
<figure class="align-default" id="id9">
<img alt="Heatmap of Mann-Whitney U metric performance (one tailed, greater than)" src="_images/example2_heatmap_opt.png" />
<figcaption>
<p><span class="caption-text">1-tailed Mann Whitney-U (greater than) test, evaluating if the query metric-feature space combination is better than the candidate-feature space combination, dimensionality reduction techniques using optimum number of dimensions to reflect theoretical maximum performance. Values denote p-values that the metric-feature space combination is a given row is performed better than the metric-feature space column given in the column by chance along.  If this value is &lt;0.05, we deem there to be a less than 5 % chance that the metric-feature space combination outperformed the other by chance.</span><a class="headerlink" href="#id9" title="Permalink to this image"></a></p>
</figcaption>
</figure>
<figure class="align-default" id="id10">
<img alt="Heatmap summary of of Mann-Whitney U metric performance (one tailed, greater than)" src="_images/example2_heatmap_summary_opt.png" />
<figcaption>
<p><span class="caption-text">Counts of the number of features-space metric pairs that were significantly better performing than other metric-feature space pairs. Suggests that scalar projection applied to full and standard scalar feature space outperforms other metrics, however the previous figure shows there is not a significant performance gain (0.05 level) in using the scalar projection over cosine similarity for full and standard scalar feature spaces.</span><a class="headerlink" href="#id10" title="Permalink to this image"></a></p>
</figcaption>
</figure>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Steven Shave.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>